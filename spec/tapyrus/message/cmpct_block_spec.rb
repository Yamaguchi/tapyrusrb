require 'spec_helper'

describe Tapyrus::Message::CmpctBlock do

  describe '#parse_from_payload' do
    subject {
      Tapyrus::Message::CmpctBlock.parse_from_payload('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96dc234b7b2ee94be6d74b58154f3275ec256d99867579a521d662b97d412dcfb23573c433ff9eb66ef96c86970ebf38e4c46389307ea568f63e2967eececb9d6897ea96d5febb7c850c557795c15f5bf20516a87172d8270427e0793539ffafa25be31d7ec86f5b48966c24e56c9e6a1ab9b142a8c4b7128a79e9ef2cf2138a25ca645947c9824eb96ef751bf617e747abca767c4ea996c8595f2c0ea73f2569a772818902e0a8900851cae1b87fcb352e999f4f47ed2ed2b098afb50c90c5b1b2dfa95859d0084e36c9e7dffa15d4cdc7f3eb0bae27e3f2bbe7cad5d3d0a04b04571d0448891195fd4cce0aedf9361da04fd8cc316159f669ab95e892a4e049a4b04755222a8c7210a223439868e1522662c3cb5d20491f3813952bd0521a8395e385697a0124093185daf5fd8a353e68d8f3f145f6ed2e4b8d5c91be3d009ff00c13aa415e8e0c4555935f9c9c5097d8b69f7a84933be4f56f303c77d91b246d65ac75f05e0cb84a65fe207940bc35b918abebd1780bf7c382116eac7671874ec93ee5e3be54ac9de10d45f7167b7709f28cfc23d88d760638bc17b746a88ae274f7281ed36a2adb8fdb4ed23a5be2a3176e705e5255a1f80ac7ad8771694f520e5407449b73fa876133dc1c8b3d4e35ba8fb209cc45243f6f915ca8d6ba91296566284999c39a63ad87d127cc1bf3b63357518113836abbd182756d8f8f52c51a9aca2cdcf35fb7aa5b5d18926d4e9a6057ba852f1f675ae59e1b292be61c177bea4ce9879823d360e4ca1fb961bc8354df62857de0df427eb75cb7a7ef160f9c0a66fbcef6050af9ffa5a3c66e7deebaa63ee3a2709ce27b3937f155093c4d3582a0eb6228792e8f6a6298197bba3acaf3e939f1998fa48c9e319a47cbf414a64a93451d25d765e8d9f7631035e158aa269858f5c94cc4504abd63d8e086bbc7a744de182b0db9901e576a691f2b27cede754873eed1292e5e68f73341cab660010001000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23032c411300fe590e745afe4c2505000963676d696e6572343208000000000000000000ffffffff020c7a0e05000000001976a914f2c25ac3d59f3d674b1d1d0a25c27339aaac0ba688ac0000000000000000266a24aa21a9ed7e6376ac601ad46e980fcfa343c8e537c09f6fa3be869af422bb34c08c11599800000000'.htb)
    }
    it 'should be parsed.' do
      expect(subject.header_and_short_ids.header.block_hash).to eq('86547c8cd55adcb3532c150c225e0167d1b9f26976535cfa3abd4b4c00000000')
      expect(subject.header_and_short_ids.header.to_payload.bth).to eq('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96d')
      expect(subject.header_and_short_ids.nonce).to eq(7907921748630648002)
      expect(subject.header_and_short_ids.short_ids[0]).to eq(103525679137205)
      expect(subject.header_and_short_ids.short_ids[1]).to eq(96102457628354)
      expect(subject.header_and_short_ids.short_ids.size).to eq(116)
      expect(subject.header_and_short_ids.prefilled_txn.size).to eq(1)
      expect(subject.header_and_short_ids.prefilled_txn.first.index).to eq(0)
      expect(subject.header_and_short_ids.siphash_key.bth).to eq('d03951189c0458515f041d233adbb3cf')
      expect(subject.header_and_short_ids.prefilled_txn.first.tx.txid).to eq('161784545ae1ecd722466434806d4a081c65b5c6197ca21637041dc4c2730bd0')
      expect(subject.to_payload.bth).to eq('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96dc234b7b2ee94be6d74b58154f3275ec256d99867579a521d662b97d412dcfb23573c433ff9eb66ef96c86970ebf38e4c46389307ea568f63e2967eececb9d6897ea96d5febb7c850c557795c15f5bf20516a87172d8270427e0793539ffafa25be31d7ec86f5b48966c24e56c9e6a1ab9b142a8c4b7128a79e9ef2cf2138a25ca645947c9824eb96ef751bf617e747abca767c4ea996c8595f2c0ea73f2569a772818902e0a8900851cae1b87fcb352e999f4f47ed2ed2b098afb50c90c5b1b2dfa95859d0084e36c9e7dffa15d4cdc7f3eb0bae27e3f2bbe7cad5d3d0a04b04571d0448891195fd4cce0aedf9361da04fd8cc316159f669ab95e892a4e049a4b04755222a8c7210a223439868e1522662c3cb5d20491f3813952bd0521a8395e385697a0124093185daf5fd8a353e68d8f3f145f6ed2e4b8d5c91be3d009ff00c13aa415e8e0c4555935f9c9c5097d8b69f7a84933be4f56f303c77d91b246d65ac75f05e0cb84a65fe207940bc35b918abebd1780bf7c382116eac7671874ec93ee5e3be54ac9de10d45f7167b7709f28cfc23d88d760638bc17b746a88ae274f7281ed36a2adb8fdb4ed23a5be2a3176e705e5255a1f80ac7ad8771694f520e5407449b73fa876133dc1c8b3d4e35ba8fb209cc45243f6f915ca8d6ba91296566284999c39a63ad87d127cc1bf3b63357518113836abbd182756d8f8f52c51a9aca2cdcf35fb7aa5b5d18926d4e9a6057ba852f1f675ae59e1b292be61c177bea4ce9879823d360e4ca1fb961bc8354df62857de0df427eb75cb7a7ef160f9c0a66fbcef6050af9ffa5a3c66e7deebaa63ee3a2709ce27b3937f155093c4d3582a0eb6228792e8f6a6298197bba3acaf3e939f1998fa48c9e319a47cbf414a64a93451d25d765e8d9f7631035e158aa269858f5c94cc4504abd63d8e086bbc7a744de182b0db9901e576a691f2b27cede754873eed1292e5e68f73341cab660010001000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23032c411300fe590e745afe4c2505000963676d696e6572343208000000000000000000ffffffff020c7a0e05000000001976a914f2c25ac3d59f3d674b1d1d0a25c27339aaac0ba688ac0000000000000000266a24aa21a9ed7e6376ac601ad46e980fcfa343c8e537c09f6fa3be869af422bb34c08c11599800000000')
    end
  end

  describe '#from_block' do
    let(:block) {
      Tapyrus::Message::Block.parse_from_payload(load_block('0000000001be84d00475b5cf0148c3dfb9b7c2a770f788f22b0d96085b0f0e84').htb).to_block
    }

    context 'version 1' do
      subject {
        Tapyrus::Message::CmpctBlock.from_block(block, 7907921748630648002)
      }
      it 'should generate CmpctBlock.' do
        expect(subject.header_and_short_ids.short_ids[0]).to eq(236825725144454)
        expect(subject.header_and_short_ids.short_ids[1]).to eq(258908285135612)
        expect(subject.header_and_short_ids.short_ids[2]).to eq(259505523092848)
        expect(subject.header_and_short_ids.short_ids[3]).to eq(123652277687059)
        expect(subject.header_and_short_ids.short_ids[21]).to eq(80845630318974)
        expect(subject.header_and_short_ids.short_ids.size).to eq(38)
        expect(subject.header_and_short_ids.prefilled_txn.size).to eq(1)
        expect(subject.to_payload.bth).to eq('0200000034354a1e7097fe4abc45fc5f4f1370d1df35b4536041bb6c1f54490100000000bdefd233ba716fd2e4d608a8c182762e7c2977ffedf819c0dfe761b83309b09898459851f08a031c778b32b0c234b7b2ee94be6d26868d384964d7fc6a5dc879eb706d85d604ec1353160a7670de1cea31b155b2f5dd833c4083f904b1493bd156465ec5a96f78f6dfa11f59354532556ae639ebe07246d36a209586d47946aa8c17ba7804879389f55e72ee3eaed844583dd038a6d72424f30103a69d562f0607a706246807ffaabba767f702539bf0006d127ea9135787498796aba344c84a8ee7a3795c63d6d8329ca9b213088433f3f67b503a4eb488fb598d433011c943e4efe0c56e4017f5bceb8168c284420997b270953b9dd18a619445130a260500cb6423caddcf6b7f071ff7e9b1aa552a8e839182e8d4411ad4010001000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0d038038010102062f503253482fffffffff0160be0b2a010000002321023c648e7394478d22de8e81f6b6f750157e4b9c708b7f00755889750db2baf74eac00000000')
      end
    end
  end

end
